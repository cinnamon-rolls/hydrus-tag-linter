{% extends 'base.html' %}

{% block pagetitle %}
  {{"File Viewer"}}
{% endblock %}

{% block contenttitle %}{% endblock %}

{% block head_extra %}
  <style>
    .full_file {
      max-width: 100%;
      max-height: 100vh;
    }

    .full_file_sidebar {
      display: block;
      margin-right: 1em;
      font-size: 80%;
      width: 230px;
      float: left;
      overflow: auto;
      max-height: calc(100% - 75);
    }

    .full_file_sidebar p {
      max-width: 100%;
      word-wrap: normal;
      overflow-x: auto;
    }

    .full_file_container {
      display: block;
      float: left;
      width: calc(100% - 300px);
    }

    .tag_list {
      padding: 0 0 0 16px;
      margin: 0;
    }

    .action_button {
      display: block;
    }

    #actions_container .anchorbutton {
      text-align: left;
    }

    @media screen and (max-width: 721px) {
      .full_file_sidebar {
        display: block;
        float: none;
        width: 100%;
        margin-bottom: 16px;
        font-size: 100%;
      }

      .full_file_container {
        display: block;
        float: none;
        width: 100%;
      }
    }
  </style>
  <script type="module">
    import FileViewState, {QUEUE_RULE, QUEUE_EXEMPTIONS} from "/static/js/FileViewState.js"
    import {getTagServices} from "/static/js/tags.js"

    var state = null;

    window.addEventListener("load", async function () {
      var params = new URLSearchParams(window.location.search);
      var fileId = parseInt(params.get("file") + "");
      var ruleName = params.get("rule");
      var useRuleExemptions = params.get("exemptions") === 'true';

      state = new FileViewState();

      state.setFileId(fileId);
      state.setRuleName(ruleName);
      state.setTagService("my tags");

      if (ruleName != null) {
        if (useRuleExemptions) {
          state.setFileQueueStrategy(QUEUE_EXEMPTIONS);
        } else {
          state.setFileQueueStrategy(QUEUE_RULE);
        }
      }

      state.refresh();

      var tagServiceSelect = document.getElementById("tag_service_select");

      var tagServices = await getTagServices();
      for (let service of tagServices) {
        let serviceOption = document.createElement("option");
        serviceOption.value = service.name;
        serviceOption.innerText = service.name;
        serviceOption.id = "tag-select-option-" + service.name;
        tagServiceSelect.appendChild(serviceOption);
      }

      tagServiceSelect.addEventListener("keydown", function (e) {
        e.preventDefault();
      }, false)

      tagServiceSelect.onchange = function (e) {
        state.setTagService(tagServiceSelect.value);
        state.refresh();
      }

      document.onkeydown = async function (e) {
        if (state == null) {
          return false;
        }

        e = e || window.event;
        if (e.ctrlKey && e.keyCode == 90) {
          alert("undo not implemented (yet?)")
          return true;
        }
        var shortcutName = "";
        if (e.ctrlKey) {
          shortcutName += "ctrl+";
        }
        if (e.altKey) {
          shortcutName += "alt+";
        }
        if (e.shiftKey) {
          shortcutName += "shift+";
        }
        shortcutName += e.key;
        shortcutName = shortcutName.toLowerCase();
        // console.log(shortcutName);

        return await !state.onShortcut(shortcutName);
      };
    })
  </script>
{% endblock %}

{% block content %}
  <div class="full_file_sidebar">
    <h2 id="file_title"></h2>
    <p>
      <a id="direct_download">Direct Download</a>
    </p>

    <!-- <h3>Tools</h3> <button onclick="addTag()">Quick Add Tag</button><br> <button onclick="removeTag()">Quick Remove Tag</button><br> -->

    <h3 id="actions_header">Actions</h3>
    <div id="actions_container"></div>

    <h3 id="tags_header">Tags</h3>
    <select id="tag_service_select"></select>
    <div id="tags_container">
      <ul id="tag_list"></ul>
    </div>

    <h3>Metadata</h3>
    <div id="metadata_container">
      <p>Hash:
        <code id="hash_container"></code>
      </p>
    </div>

    <div id="rule_container" class="noshow">
      <h3 id="rule_header">Rule Info</h3>
      <p id="rule_note"></p>
      <a id="rule_page_link">(Rule Page)</a>
    </div>
  </div>

  <div id="file_embed_container" class="full_file_container"></div>

{% endblock %}
