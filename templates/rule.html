{% extends 'base.html' %}

{% block head_extra %}
  <style>
    #gallery_container {
      float: left;
      display: block;
      max-width: calc(100% - 550px);
    }

    #side_info {
      float: left;
      display: block;
      max-width: 520px;
      margin-right: 16px;
    }
  </style>
  <script src="{{ url_for('static', filename='js/async_helper.js') }}"></script>
  <script src="{{ url_for('static', filename='js/gallery_helper.js') }}"></script>
  <script>
    var linterRuleTag = "{{ rule.get_linter_rule_tag() }}"
    var linterRuleTagURI = encodeURI(linterRuleTag)

    var ruleName = "{{ rule.get_name() }}"
    var ruleNameURI = encodeURI(ruleName)

    var applyLinterTagURL = "/api/rules/apply_linter_tag?name=" + ruleNameURI

    function applyLinterTagSetup() {
      var btn = document.getElementById("mass_tag_button");
      btn.onclick = async function (e) {
        var linterRuleTag = "{{ rule.get_linter_rule_tag }}"

        if (linterRuleTag == null) 
          return;
        
        console.log("Got tag name: '" + linterRuleTag + "'")

        preview = await httpGETJSON(applyLinterTagURL + "&tag=" + linterRuleTagURI + "&preview=true")
        console.log("preview: " + JSON.stringify(preview))

        var apply = confirm("the tag '" + preview.tag + "' will be added to " + preview.added + " files and removed from " + preview.removed + " on the service '" + preview.tag_service + "'. Is this OK?")

        if (apply) {
          console.log('applying...')
          response = await httpGETJSON(applyLinterTagURL + "&tag=" + linterRuleTagURI + "&preview=false")
          console.log('response: ' + JSON.stringify(response))
          window
            .location
            .reload()
        }
      }
    }

    async function getRuleFiles(rule) {
      return httpGETJSON('/api/rules/get_files?name=' + ruleNameURI)
    }

    window.addEventListener("load", async function () {
      applyLinterTagSetup()
      createGallery(await getRuleFiles(), {
        ruleName: ruleName
      })
    })
  </script>
{% endblock %}

{% block pagetitle %}
  Rule:
  {{ rule.name }}
{% endblock %}

{% block contenttitle %}{% endblock %}

{% block content %}

  {% set files = rule.get_files() %}
  {% set files_count = len(files) %}

  <div id="side_info">

    <h2>{{ rule.name }}</h2>

    {% if rule.note %}
      <p>{{ rule.note }}</p>
    {% endif %}

    <p>
      There are
      <code>{{ files_count }}</code>
      files detected by this rule
    </p>

    <h3>Actions</h3>

    <h4>Sync Rule Tag</h4>
    <span>
      This action will automatically add the
      <code>{{ rule.get_linter_rule_tag()}}</code>
      tag to all of the noncompliant files, and remove it from files that are currently compliant. This will allow you to search for these files in other applications. Remember to re-sync once you are done making your changes.
    </span>
    <ul>
      <li>
        {{ icon_btn(id='mass_tag_button', text="Sync Rule Tag...", icon='tag_blue_edit') }}
      </li>
    </ul>
  </div>

  <div id="gallery_container">
    <h2>Files</h2>
    <div class="gallery" id="gallery"></div>
  </div>

{% endblock %}
