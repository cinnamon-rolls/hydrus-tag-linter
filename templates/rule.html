{% extends 'base.html' %}

{% block head_extra %}
  <script src="{{ url_for('static', filename='async_helper.js') }}"></script>
  <script>
    var ruleName = "{{ rule.get_name() }}"
    var ruleNameEnc = encodeURI(ruleName)

    function copyHashesSetup() {
      function getCopyFunc(elem) {
        return function (e) {
          navigator
            .clipboard
            .writeText(elem.innerText)
        }
      }
      var btn = document.getElementById("copy_hashes_button");
      var hashes = document.getElementById("hashes_holder")
      btn.onclick = getCopyFunc(hashes)
    }

    var applyLinterTagURL = "/api/rules/apply_linter_tag?name=" + ruleNameEnc

    function applyLinterTagSetup() {
      var btn = document.getElementById("mass_tag_button");
      btn.onclick = async function (e) {
        var tagName = "{{ rule.get_linter_rule_tag() }}"

        if (tagName == null) 
          return;
        
        console.log("Got tag name: '" + tagName + "'")

        preview = await httpGETJSON(applyLinterTagURL + "&tag=" + encodeURI(tagName) + "&preview=true")
        console.log("preview: " + JSON.stringify(preview))

        var apply = confirm("the tag '" + preview.tag + "' will be added to " + preview.added + " files and removed from " + preview.removed + " on the service '" + preview.tag_service + "'. Is this OK?")

        if (apply) {
          console.log('applying...')
          response = await httpGETJSON(applyLinterTagURL + "&tag=" + encodeURI(tagName) + "&preview=false")
          console.log('response: ' + JSON.stringify(response))
          window
            .location
            .reload()
        }
      }
    }

    window.addEventListener("load", function () {
      copyHashesSetup()
      applyLinterTagSetup()
    })
  </script>
{% endblock %}

{% block pagetitle %} Rule: {{ rule.name }} {% endblock %}

{% block contenttitle %} Rule: {{ rule.name }} {% endblock %}

{% block content %}

  {% if rule.note %}
    <p>{{ rule.note }}</p>
  {% endif %}

  <p>
    There are
    <code>{{ len(server.get_rule_files(rule)) }}</code>
    files detected by this rule
  </p>

  <h3>Actions</h3>

  <h4>Sync Rule Tag</h4>
  <span>
    This action will automatically add the
    <code>{{ rule.get_linter_rule_tag()}}</code>
    tag to all of the noncompliant files, and remove it from files that are
    currently compliant. This will allow you to search for these files in other
    applications. Remember to re-sync once you are done making your changes.
  </span>
  <ul>
    <li>
      <button id='mass_tag_button'>
        <span class='icon icon_tag_blue_edit'>Sync Rule Tag...</span>
      </button>
    </li>
  </ul>

  <h4>Hashes</h4>

  <p>
    Here are all the SHA-256 hashes for each noncompliant file. You can paste
    these hashes into the
    <code>system:hashes</code>
    search in your Hydrus client.
  </p>

  <div class='hashes'>
    <button id='copy_hashes_button'>
      <span class='icon icon_page_copy'>Copy All</span>
    </button>
    <br>
    <code>
      <pre id='hashes_holder'>{{ server.get_rule_hashes_as_str(rule) }}</pre>
    </code>
  </div>

{% endblock %}
